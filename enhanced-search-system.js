/**
 * ูุธุงู ุงูุจุญุซ ุงููุญุณู ูุน ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุชุญุณูู ูุญุฑูุงุช ุงูุจุญุซ
 * Enhanced Search System with AI and SEO Optimization
 */

class EnhancedSearchSystem {
    constructor() {
        this.searchData = [];
        this.searchIndex = new Map();
        this.searchHistory = this.getSearchHistory();
        this.searchAnalytics = this.getSearchAnalytics();
        this.aiSuggestions = [];
        this.searchFilters = {
            stage: '',
            grade: '',
            subject: '',
            contentType: '',
            difficulty: '',
            language: 'ar'
        };
        
        this.init();
    }

    async init() {
        console.log('๐ ุชููุฆุฉ ูุธุงู ุงูุจุญุซ ุงููุญุณู...');
        
        // ุชุญููู ุจูุงูุงุช ุงูุจุญุซ
        await this.loadSearchData();
        
        // ุฅูุดุงุก ููุฑุณ ุงูุจุญุซ
        this.buildSearchIndex();
        
        // ุฅูุดุงุก ูุงุฌูุฉ ุงูุจุญุซ ุงููุญุณูุฉ
        this.createEnhancedSearchUI();
        
        // ุชูุนูู ุงูุจุญุซ ุงูุฐูู
        this.enableSmartSearch();
        
        // ุชุชุจุน ุชุญูููุงุช ุงูุจุญุซ
        this.initSearchAnalytics();
        
        console.log('โ ุชู ุชููุฆุฉ ูุธุงู ุงูุจุญุซ ุจูุฌุงุญ');
    }

    async loadSearchData() {
        // ูุญุงูุงุฉ ุชุญููู ุงูุจูุงูุงุช ูู API
        try {
            // ุจูุงูุงุช ููุณุนุฉ ูููุญุชูู ุงูุชุนูููู
            this.searchData = [
                // ุงููุฑุญูุฉ ุงูุงุจุชุฏุงุฆูุฉ - ุงูุตู ุงูุฃูู
                {
                    id: 'ar_1_1',
                    title: 'ูุชุงุจ ุงููุบุฉ ุงูุนุฑุจูุฉ ููุตู ุงูุฃูู ุงูุงุจุชุฏุงุฆู - ุงููุตู ุงูุฏุฑุงุณู ุงูุฃูู',
                    description: 'ูุชุงุจ ุงููุบุฉ ุงูุนุฑุจูุฉ ุงูููุฑุฑ ูู ูุฒุงุฑุฉ ุงูุชุฑุจูุฉ ูุงูุชุนููู ููุตู ุงูุฃูู ุงูุงุจุชุฏุงุฆูุ ูุญุชูู ุนูู ุฏุฑูุณ ุงููุฑุงุกุฉ ูุงููุชุงุจุฉ ูุงูุฅููุงุก',
                    stage: 'primary',
                    grade: '1',
                    subject: 'arabic',
                    contentType: 'book',
                    difficulty: 'beginner',
                    keywords: ['ูุฑุงุกุฉ', 'ูุชุงุจุฉ', 'ุฅููุงุก', 'ุญุฑูู', 'ูููุงุช', 'ุฌูู'],
                    author: 'ูุฒุงุฑุฉ ุงูุชุฑุจูุฉ ูุงูุชุนููู',
                    publishDate: '2024',
                    downloadCount: 15420,
                    rating: 4.8,
                    fileSize: '12.5 MB',
                    pages: 98,
                    language: 'ar',
                    thumbnail: 'images/books/arabic/grade1-arabic.jpg',
                    downloadUrl: 'primary/grade1/arabic/arabic-book-term1.pdf',
                    previewUrl: 'primary/grade1/arabic/preview.html'
                },
                {
                    id: 'math_1_1',
                    title: 'ูุชุงุจ ุงูุฑูุงุถูุงุช ููุตู ุงูุฃูู ุงูุงุจุชุฏุงุฆู - ูููุฌ ุฌุฏูุฏ 2024',
                    description: 'ูุชุงุจ ุงูุฑูุงุถูุงุช ุงููุทูุฑ ููุตู ุงูุฃูู ุงูุงุจุชุฏุงุฆูุ ูุดูู ุงูุฃุฑูุงู ูุงูุนูููุงุช ุงูุญุณุงุจูุฉ ุงูุจุณูุทุฉ ูุงูุฃุดูุงู ุงูููุฏุณูุฉ',
                    stage: 'primary',
                    grade: '1',
                    subject: 'math',
                    contentType: 'book',
                    difficulty: 'beginner',
                    keywords: ['ุฃุฑูุงู', 'ุฌูุน', 'ุทุฑุญ', 'ุฃุดูุงู', 'ุฃููุงู', 'ููุงุณ'],
                    author: 'ูุฒุงุฑุฉ ุงูุชุฑุจูุฉ ูุงูุชุนููู',
                    publishDate: '2024',
                    downloadCount: 12890,
                    rating: 4.7,
                    fileSize: '15.2 MB',
                    pages: 112,
                    language: 'ar',
                    thumbnail: 'images/books/math/grade1-math.jpg',
                    downloadUrl: 'primary/grade1/math/math-book.pdf',
                    previewUrl: 'primary/grade1/math/preview.html'
                },
                // ูุฐูุฑุงุช ุชููู
                {
                    id: 'excellence_ar_1',
                    title: 'ูุฐูุฑุฉ ุงูุชููู ูู ุงููุบุฉ ุงูุนุฑุจูุฉ - ุฃููู ุงุจุชุฏุงุฆู',
                    description: 'ูุฐูุฑุฉ ุดุงููุฉ ููุจุณุทุฉ ูุชุนููู ุงููุฑุงุกุฉ ูุงููุชุงุจุฉ ููุตู ุงูุฃูู ุงูุงุจุชุฏุงุฆู ูุน ุชูุงุฑูู ุชูุงุนููุฉ ูุฃูุดุทุฉ ููุชุนุฉ',
                    stage: 'primary',
                    grade: '1',
                    subject: 'arabic',
                    contentType: 'note',
                    difficulty: 'beginner',
                    keywords: ['ุชููู', 'ุชูุงุฑูู', 'ุฃูุดุทุฉ', 'ุชูุงุนูู', 'ูุจุณุท'],
                    author: 'ุงูุฃุณุชุงุฐ ูุญูุฏ ุนูู',
                    publishDate: '2024',
                    downloadCount: 8765,
                    rating: 4.9,
                    fileSize: '8.7 MB',
                    pages: 65,
                    language: 'ar',
                    thumbnail: 'images/notes/excellence-arabic-1.jpg',
                    downloadUrl: 'primary/grade1/arabic/excellence-note.pdf',
                    previewUrl: 'primary/grade1/arabic/excellence-preview.html'
                },
                // ุงููุฑุญูุฉ ุงูุฅุนุฏุงุฏูุฉ
                {
                    id: 'science_prep_1',
                    title: 'ูุชุงุจ ุงูุนููู ููุตู ุงูุฃูู ุงูุฅุนุฏุงุฏู - ุงูุชุฑู ุงูุฃูู',
                    description: 'ูุชุงุจ ุงูุนููู ุงูุดุงูู ููุตู ุงูุฃูู ุงูุฅุนุฏุงุฏูุ ูุบุทู ุฃุณุงุณูุงุช ุงูููุฒูุงุก ูุงูููููุงุก ูุงูุฃุญูุงุก ุจุทุฑููุฉ ูุจุณุทุฉ ููุดููุฉ',
                    stage: 'preparatory',
                    grade: '1',
                    subject: 'science',
                    contentType: 'book',
                    difficulty: 'intermediate',
                    keywords: ['ููุฒูุงุก', 'ููููุงุก', 'ุฃุญูุงุก', 'ุชุฌุงุฑุจ', 'ุนููู'],
                    author: 'ูุฒุงุฑุฉ ุงูุชุฑุจูุฉ ูุงูุชุนููู',
                    publishDate: '2024',
                    downloadCount: 9543,
                    rating: 4.6,
                    fileSize: '18.9 MB',
                    pages: 156,
                    language: 'ar',
                    thumbnail: 'images/books/science/prep1-science.jpg',
                    downloadUrl: 'preparatory/grade1/science/science-book.pdf',
                    previewUrl: 'preparatory/grade1/science/preview.html'
                },
                // ุงููุฑุญูุฉ ุงูุซุงูููุฉ
                {
                    id: 'physics_sec_1',
                    title: 'ูุชุงุจ ุงูุชููู ูู ุงูููุฒูุงุก - ุฃููู ุซุงููู',
                    description: 'ูุชุงุจ ุงูุชููู ูู ุงูููุฒูุงุก ููุตู ุงูุฃูู ุงูุซุงูููุ ุดุฑุญ ููุตู ูุน ุญููู ูููุฐุฌูุฉ ูุชูุงุฑูู ูุชุฏุฑุฌุฉ ุงูุตุนูุจุฉ',
                    stage: 'secondary',
                    grade: '1',
                    subject: 'physics',
                    contentType: 'book',
                    difficulty: 'advanced',
                    keywords: ['ููุฒูุงุก', 'ุชููู', 'ุญููู', 'ุชูุงุฑูู', 'ูุชูุฏู'],
                    author: 'ุฏุงุฑ ุงูุชููู',
                    publishDate: '2024',
                    downloadCount: 7821,
                    rating: 4.8,
                    fileSize: '22.4 MB',
                    pages: 298,
                    language: 'ar',
                    thumbnail: 'images/books/physics/altafawok-physics.jpg',
                    downloadUrl: 'secondary/physics/altafawok-physics.html',
                    previewUrl: 'secondary/physics/preview.html'
                },
                // ูุฑุงุฌุนุงุช ููุงุฆูุฉ
                {
                    id: 'final_review_math_6',
                    title: 'ุงููุฑุงุฌุนุฉ ุงูููุงุฆูุฉ ูู ุงูุฑูุงุถูุงุช - ุณุงุฏุณุฉ ุงุจุชุฏุงุฆู',
                    description: 'ูุฑุงุฌุนุฉ ุดุงููุฉ ูููุงุฆูุฉ ููููุฌ ุงูุฑูุงุถูุงุช ููุตู ุงูุณุงุฏุณ ุงูุงุจุชุฏุงุฆูุ ุชุดูู ุฌููุน ุงููุญุฏุงุช ูุน ููุงุฐุฌ ุงูุชุญุงูุงุช',
                    stage: 'primary',
                    grade: '6',
                    subject: 'math',
                    contentType: 'review',
                    difficulty: 'intermediate',
                    keywords: ['ูุฑุงุฌุนุฉ', 'ููุงุฆูุฉ', 'ุดุงููุฉ', 'ุงูุชุญุงูุงุช', 'ููุงุฐุฌ'],
                    author: 'ุงูุฃุณุชุงุฐ ุฃุญูุฏ ุณุงูู',
                    publishDate: '2024',
                    downloadCount: 11234,
                    rating: 4.9,
                    fileSize: '14.8 MB',
                    pages: 89,
                    language: 'ar',
                    thumbnail: 'images/reviews/math-grade6-final.jpg',
                    downloadUrl: 'primary/grade6/math/final-review.pdf',
                    previewUrl: 'primary/grade6/math/review-preview.html'
                }
            ];
            
            // ุฅุถุงูุฉ ุงููุฒูุฏ ูู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ
            this.generateMoreData();
            
        } catch (error) {
            console.error('ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช ุงูุจุญุซ:', error);
        }
    }

    generateMoreData() {
        // ุฅูุดุงุก ุงููุฒูุฏ ูู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ
        const subjects = ['arabic', 'math', 'english', 'science', 'social', 'religion'];
        const stages = ['primary', 'preparatory', 'secondary'];
        const contentTypes = ['book', 'note', 'exam', 'review'];
        const gradesByStage = {
            'primary': ['1', '2', '3', '4', '5', '6'],
            'preparatory': ['1', '2', '3'],
            'secondary': ['1', '2', '3']
        };

        let idCounter = 1000;
        
        stages.forEach(stage => {
            gradesByStage[stage].forEach(grade => {
                subjects.forEach(subject => {
                    contentTypes.forEach(contentType => {
                        this.searchData.push({
                            id: `gen_${idCounter++}`,
                            title: this.generateTitle(subject, stage, grade, contentType),
                            description: this.generateDescription(subject, stage, grade, contentType),
                            stage,
                            grade,
                            subject,
                            contentType,
                            difficulty: this.getDifficulty(stage),
                            keywords: this.generateKeywords(subject, contentType),
                            author: this.getRandomAuthor(),
                            publishDate: '2024',
                            downloadCount: Math.floor(Math.random() * 20000) + 1000,
                            rating: (Math.random() * 1.5 + 3.5).toFixed(1),
                            fileSize: `${(Math.random() * 20 + 5).toFixed(1)} MB`,
                            pages: Math.floor(Math.random() * 200) + 50,
                            language: 'ar',
                            thumbnail: `images/${contentType}s/${subject}/${stage}-${grade}.jpg`,
                            downloadUrl: `${stage}/grade${grade}/${subject}/${contentType}.pdf`,
                            previewUrl: `${stage}/grade${grade}/${subject}/preview.html`
                        });
                    });
                });
            });
        });
    }

    generateTitle(subject, stage, grade, contentType) {
        const subjectNames = {
            'arabic': 'ุงููุบุฉ ุงูุนุฑุจูุฉ',
            'math': 'ุงูุฑูุงุถูุงุช',
            'english': 'ุงููุบุฉ ุงูุฅูุฌููุฒูุฉ',
            'science': 'ุงูุนููู',
            'social': 'ุงูุฏุฑุงุณุงุช ุงูุงุฌุชูุงุนูุฉ',
            'religion': 'ุงูุชุฑุจูุฉ ุงูุฏูููุฉ'
        };

        const stageNames = {
            'primary': 'ุงูุงุจุชุฏุงุฆู',
            'preparatory': 'ุงูุฅุนุฏุงุฏู',
            'secondary': 'ุงูุซุงููู'
        };

        const contentTypeNames = {
            'book': 'ูุชุงุจ',
            'note': 'ูุฐูุฑุฉ',
            'exam': 'ุงูุชุญุงู',
            'review': 'ูุฑุงุฌุนุฉ'
        };

        return `${contentTypeNames[contentType]} ${subjectNames[subject]} - ุงูุตู ${this.getGradeInArabic(grade)} ${stageNames[stage]}`;
    }

    generateDescription(subject, stage, grade, contentType) {
        const descriptions = {
            'book': 'ูุชุงุจ ุดุงูู ูููุตู ูุบุทู ุฌููุน ุฃุฌุฒุงุก ุงููููุฌ',
            'note': 'ูุฐูุฑุฉ ูุจุณุทุฉ ููุฑูุฒุฉ ููููู ุงูุณุฑูุน',
            'exam': 'ููุงุฐุฌ ุงูุชุญุงูุงุช ูุชููุนุฉ ูุน ุงูุญููู ุงููููุฐุฌูุฉ',
            'review': 'ูุฑุงุฌุนุฉ ููุงุฆูุฉ ุดุงููุฉ ูุฌููุน ุงููุญุฏุงุช'
        };

        return descriptions[contentType] + ` ููุตู ${this.getGradeInArabic(grade)} ูู ูุงุฏุฉ ${this.getSubjectInArabic(subject)}`;
    }

    getGradeInArabic(grade) {
        const grades = {
            '1': 'ุงูุฃูู',
            '2': 'ุงูุซุงูู',
            '3': 'ุงูุซุงูุซ',
            '4': 'ุงูุฑุงุจุน',
            '5': 'ุงูุฎุงูุณ',
            '6': 'ุงูุณุงุฏุณ'
        };
        return grades[grade] || grade;
    }

    getSubjectInArabic(subject) {
        const subjects = {
            'arabic': 'ุงููุบุฉ ุงูุนุฑุจูุฉ',
            'math': 'ุงูุฑูุงุถูุงุช',
            'english': 'ุงููุบุฉ ุงูุฅูุฌููุฒูุฉ',
            'science': 'ุงูุนููู',
            'social': 'ุงูุฏุฑุงุณุงุช ุงูุงุฌุชูุงุนูุฉ',
            'religion': 'ุงูุชุฑุจูุฉ ุงูุฏูููุฉ'
        };
        return subjects[subject] || subject;
    }

    getDifficulty(stage) {
        const difficulties = {
            'primary': 'beginner',
            'preparatory': 'intermediate',
            'secondary': 'advanced'
        };
        return difficulties[stage];
    }

    generateKeywords(subject, contentType) {
        const baseKeywords = {
            'arabic': ['ูุฑุงุกุฉ', 'ูุชุงุจุฉ', 'ุฅููุงุก', 'ูุญู', 'ุตุฑู', 'ุฃุฏุจ'],
            'math': ['ุญุณุงุจ', 'ุฌุจุฑ', 'ููุฏุณุฉ', 'ุฅุญุตุงุก', 'ุฃุฑูุงู', 'ูุนุงุฏูุงุช'],
            'english': ['grammar', 'vocabulary', 'reading', 'writing', 'speaking'],
            'science': ['ุชุฌุงุฑุจ', 'ููุฒูุงุก', 'ููููุงุก', 'ุฃุญูุงุก', 'ุนููู'],
            'social': ['ุชุงุฑูุฎ', 'ุฌุบุฑุงููุง', 'ุงุฌุชูุงุน', 'ูุทููุฉ', 'ุญุถุงุฑุฉ'],
            'religion': ['ูุฑุขู', 'ุณูุฑุฉ', 'ููู', 'ุฃุฎูุงู', 'ุนุจุงุฏุฉ']
        };

        const contentKeywords = {
            'book': ['ูููุฌ', 'ููุฑุฑ', 'ุฑุณูู'],
            'note': ['ุดุฑุญ', 'ูุจุณุท', 'ููุฎุต'],
            'exam': ['ุงุฎุชุจุงุฑ', 'ูููุฐุฌ', 'ุญููู'],
            'review': ['ูุฑุงุฌุนุฉ', 'ููุงุฆูุฉ', 'ุดุงููุฉ']
        };

        return [...(baseKeywords[subject] || []), ...(contentKeywords[contentType] || [])];
    }

    getRandomAuthor() {
        const authors = [
            'ูุฒุงุฑุฉ ุงูุชุฑุจูุฉ ูุงูุชุนููู',
            'ุฏุงุฑ ุงูุชููู',
            'ุงูุฃุณุชุงุฐ ูุญูุฏ ุฃุญูุฏ',
            'ุงูุฃุณุชุงุฐุฉ ูุงุทูุฉ ุณุงูู',
            'ุงูุฃุณุชุงุฐ ุฃุญูุฏ ุนูู',
            'ุฏุงุฑ ุงููุนุฑูุฉ',
            'ุงูุฃุณุชุงุฐ ุฎุงูุฏ ูุญููุฏ',
            'ุงูุฃุณุชุงุฐุฉ ููุฑุง ุญุณู'
        ];
        return authors[Math.floor(Math.random() * authors.length)];
    }

    buildSearchIndex() {
        // ุจูุงุก ููุฑุณ ุงูุจุญุซ ูููุตูู ุงูุณุฑูุน
        this.searchIndex.clear();
        
        this.searchData.forEach(item => {
            // ููุฑุณุฉ ุงูุนููุงู
            this.indexText(item.title, item);
            
            // ููุฑุณุฉ ุงููุตู
            this.indexText(item.description, item);
            
            // ููุฑุณุฉ ุงููููุงุช ุงูููุชุงุญูุฉ
            item.keywords.forEach(keyword => {
                this.indexText(keyword, item);
            });
            
            // ููุฑุณุฉ ุงููุคูู
            this.indexText(item.author, item);
        });
    }

    indexText(text, item) {
        if (!text) return;
        
        // ุชูุณูู ุงููุต ุฅูู ูููุงุช
        const words = text.toLowerCase()
            .replace(/[^\u0600-\u06FF\u0750-\u077F\uFB50-\uFDFF\uFE70-\uFEFF\w\s]/g, '')
            .split(/\s+/)
            .filter(word => word.length > 2);
        
        words.forEach(word => {
            if (!this.searchIndex.has(word)) {
                this.searchIndex.set(word, new Set());
            }
            this.searchIndex.get(word).add(item);
        });
    }

    createEnhancedSearchUI() {
        // ุฅูุดุงุก ูุงุฌูุฉ ุงูุจุญุซ ุงููุญุณูุฉ
        const searchContainer = document.createElement('div');
        searchContainer.id = 'enhanced-search-container';
        searchContainer.innerHTML = `
            <div class="enhanced-search-modal" id="enhanced-search-modal">
                <div class="search-backdrop" onclick="enhancedSearchSystem.closeSearch()"></div>
                <div class="search-container">
                    <div class="search-header">
                        <h2><i class="fas fa-search"></i> ุงูุจุญุซ ุงูุฐูู ุงููุชูุฏู</h2>
                        <button class="close-search" onclick="enhancedSearchSystem.closeSearch()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="search-input-section">
                        <div class="main-search-box">
                            <input type="text" 
                                   id="enhanced-search-input" 
                                   placeholder="ุงุจุญุซ ุนู ุงููุฐูุฑุงุช ูุงููุชุจ ูุงููุฑุงุฌุนุงุช..." 
                                   autocomplete="off"
                                   spellcheck="false">
                            <button class="voice-search-btn" onclick="enhancedSearchSystem.startVoiceSearch()">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="clear-search-btn" onclick="enhancedSearchSystem.clearSearch()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="search-suggestions" id="search-suggestions"></div>
                        
                        <div class="search-filters-toggle">
                            <button onclick="enhancedSearchSystem.toggleFilters()">
                                <i class="fas fa-filter"></i> ููุงุชุฑ ุงูุจุญุซ ุงููุชูุฏูุฉ
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        
                        <div class="search-filters" id="search-filters">
                            <div class="filters-grid">
                                <div class="filter-item">
                                    <label>ุงููุฑุญูุฉ:</label>
                                    <select id="stage-filter">
                                        <option value="">ุฌููุน ุงููุฑุงุญู</option>
                                        <option value="primary">ุงูุงุจุชุฏุงุฆู</option>
                                        <option value="preparatory">ุงูุฅุนุฏุงุฏู</option>
                                        <option value="secondary">ุงูุซุงููู</option>
                                    </select>
                                </div>
                                
                                <div class="filter-item">
                                    <label>ุงูุตู:</label>
                                    <select id="grade-filter">
                                        <option value="">ุฌููุน ุงูุตููู</option>
                                    </select>
                                </div>
                                
                                <div class="filter-item">
                                    <label>ุงููุงุฏุฉ:</label>
                                    <select id="subject-filter">
                                        <option value="">ุฌููุน ุงูููุงุฏ</option>
                                        <option value="arabic">ุงููุบุฉ ุงูุนุฑุจูุฉ</option>
                                        <option value="math">ุงูุฑูุงุถูุงุช</option>
                                        <option value="english">ุงููุบุฉ ุงูุฅูุฌููุฒูุฉ</option>
                                        <option value="science">ุงูุนููู</option>
                                        <option value="social">ุงูุฏุฑุงุณุงุช ุงูุงุฌุชูุงุนูุฉ</option>
                                        <option value="religion">ุงูุชุฑุจูุฉ ุงูุฏูููุฉ</option>
                                    </select>
                                </div>
                                
                                <div class="filter-item">
                                    <label>ููุน ุงููุญุชูู:</label>
                                    <select id="content-filter">
                                        <option value="">ุฌููุน ุงูุฃููุงุน</option>
                                        <option value="book">ูุชุจ ูุฏุฑุณูุฉ</option>
                                        <option value="note">ูุฐูุฑุงุช</option>
                                        <option value="exam">ุงูุชุญุงูุงุช</option>
                                        <option value="review">ูุฑุงุฌุนุงุช</option>
                                    </select>
                                </div>
                                
                                <div class="filter-item">
                                    <label>ูุณุชูู ุงูุตุนูุจุฉ:</label>
                                    <select id="difficulty-filter">
                                        <option value="">ุฌููุน ุงููุณุชููุงุช</option>
                                        <option value="beginner">ูุจุชุฏุฆ</option>
                                        <option value="intermediate">ูุชูุณุท</option>
                                        <option value="advanced">ูุชูุฏู</option>
                                    </select>
                                </div>
                                
                                <div class="filter-item">
                                    <label>ุชุฑุชูุจ ุงููุชุงุฆุฌ:</label>
                                    <select id="sort-filter">
                                        <option value="relevance">ุงูุฃูุซุฑ ุตูุฉ</option>
                                        <option value="downloads">ุงูุฃูุซุฑ ุชุญูููุงู</option>
                                        <option value="rating">ุงูุฃุนูู ุชููููุงู</option>
                                        <option value="newest">ุงูุฃุญุฏุซ</option>
                                        <option value="title">ุงูุชุฑุชูุจ ุงูุฃุจุฌุฏู</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="filter-actions">
                                <button class="apply-filters" onclick="enhancedSearchSystem.applyFilters()">
                                    <i class="fas fa-check"></i> ุชุทุจูู ุงูููุงุชุฑ
                                </button>
                                <button class="reset-filters" onclick="enhancedSearchSystem.resetFilters()">
                                    <i class="fas fa-undo"></i> ุฅุนุงุฏุฉ ุชุนููู
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="search-results-section">
                        <div class="results-header" id="results-header" style="display: none;">
                            <div class="results-count">
                                <span id="results-count-text">0 ูุชูุฌุฉ</span>
                                <span id="search-time"></span>
                            </div>
                            <div class="view-options">
                                <button class="view-toggle active" data-view="grid">
                                    <i class="fas fa-th"></i>
                                </button>
                                <button class="view-toggle" data-view="list">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="search-results" id="search-results"></div>
                        
                        <div class="load-more-container" id="load-more-container" style="display: none;">
                            <button class="load-more-btn" onclick="enhancedSearchSystem.loadMoreResults()">
                                <i class="fas fa-plus"></i> ุชุญููู ุงููุฒูุฏ ูู ุงููุชุงุฆุฌ
                            </button>
                        </div>
                    </div>
                    
                    <div class="search-history-section" id="search-history">
                        <h3><i class="fas fa-history"></i> ุงูุจุญุซุงุช ุงูุฃุฎูุฑุฉ</h3>
                        <div class="history-items" id="history-items"></div>
                    </div>
                    
                    <div class="popular-searches-section">
                        <h3><i class="fas fa-fire"></i> ุงูุจุญุซุงุช ุงูุดุงุฆุนุฉ</h3>
                        <div class="popular-items" id="popular-items"></div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(searchContainer);
        
        // ุฅุถุงูุฉ ุฒุฑ ุงูุจุญุซ ุงูุนุงุฆู
        this.createFloatingSearchButton();
        
        // ุชูุนูู ุฃุญุฏุงุซ ุงูุจุญุซ
        this.setupSearchEvents();
    }

    createFloatingSearchButton() {
        const floatingBtn = document.createElement('div');
        floatingBtn.className = 'floating-search-btn';
        floatingBtn.innerHTML = `
            <button onclick="enhancedSearchSystem.openSearch()">
                <i class="fas fa-search"></i>
                <span>ุงูุจุญุซ ุงููุชูุฏู</span>
            </button>
        `;
        document.body.appendChild(floatingBtn);
    }

    setupSearchEvents() {
        const searchInput = document.getElementById('enhanced-search-input');
        
        if (searchInput) {
            // ุงูุจุญุซ ุงููุจุงุดุฑ ุฃุซูุงุก ุงููุชุงุจุฉ
            searchInput.addEventListener('input', (e) => {
                this.handleSearchInput(e.target.value);
            });
            
            // ุงูุชููู ุจุงูููุจูุฑุฏ
            searchInput.addEventListener('keydown', (e) => {
                this.handleKeyboardNavigation(e);
            });
            
            // ุงูุชุฑููุฒ ุนูู ุงูุจุญุซ
            searchInput.addEventListener('focus', () => {
                this.showSearchSuggestions();
            });
        }
        
        // ููุงุชุฑ ุงูุจุญุซ
        ['stage-filter', 'grade-filter', 'subject-filter', 'content-filter', 'difficulty-filter', 'sort-filter'].forEach(filterId => {
            const filter = document.getElementById(filterId);
            if (filter) {
                filter.addEventListener('change', () => {
                    this.updateSearchFilters();
                    this.performSearch();
                });
            }
        });
        
        // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุตููู ุนูุฏ ุชุบููุฑ ุงููุฑุญูุฉ
        const stageFilter = document.getElementById('stage-filter');
        if (stageFilter) {
            stageFilter.addEventListener('change', () => {
                this.updateGradeOptions();
            });
        }
    }

    handleSearchInput(query) {
        // ุฅูุบุงุก ุงูุจุญุซ ุงูุณุงุจู
        if (this.searchTimeout) {
            clearTimeout(this.searchTimeout);
        }
        
        // ุงูุจุญุซ ูุน ุชุฃุฎูุฑ ููุฃุฏุงุก
        this.searchTimeout = setTimeout(() => {
            if (query.trim().length > 0) {
                this.performSearch(query);
            } else {
                this.showDefaultContent();
            }
        }, 300);
    }

    async performSearch(query = null) {
        const searchStartTime = performance.now();
        
        if (!query) {
            query = document.getElementById('enhanced-search-input')?.value || '';
        }
        
        // ุชุณุฌูู ุงูุจุญุซ ูู ุงูุชุญูููุงุช
        this.recordSearch(query);
        
        // ุชุทุจูู ุงูููุงุชุฑ
        let results = this.searchInData(query);
        results = this.applyCurrentFilters(results);
        results = this.sortResults(results);
        
        // ุนุฑุถ ุงููุชุงุฆุฌ
        const searchTime = (performance.now() - searchStartTime).toFixed(2);
        this.displayResults(results, query, searchTime);
        
        // ุญูุธ ูู ุงูุชุงุฑูุฎ
        if (query.trim()) {
            this.addToSearchHistory(query);
        }
    }

    searchInData(query) {
        if (!query || query.trim().length === 0) {
            return this.searchData;
        }
        
        const searchTerms = query.toLowerCase()
            .replace(/[^\u0600-\u06FF\u0750-\u077F\uFB50-\uFDFF\uFE70-\uFEFF\w\s]/g, '')
            .split(/\s+/)
            .filter(term => term.length > 1);
        
        const results = new Map();
        
        searchTerms.forEach(term => {
            // ุงูุจุญุซ ูู ุงูููุฑุณ
            this.searchIndex.forEach((items, indexedTerm) => {
                if (indexedTerm.includes(term)) {
                    const relevanceScore = this.calculateRelevance(term, indexedTerm);
                    items.forEach(item => {
                        const currentScore = results.get(item) || 0;
                        results.set(item, currentScore + relevanceScore);
                    });
                }
            });
        });
        
        // ุชุฑุชูุจ ุญุณุจ ุงูุตูุฉ
        return Array.from(results.entries())
            .sort((a, b) => b[1] - a[1])
            .map(([item]) => item);
    }

    calculateRelevance(searchTerm, indexedTerm) {
        if (indexedTerm === searchTerm) return 10; // ุชุทุงุจู ุชุงู
        if (indexedTerm.startsWith(searchTerm)) return 8; // ูุจุฏุฃ ุจู
        if (indexedTerm.includes(searchTerm)) return 5; // ูุญุชูู ุนูู
        return 2; // ุตูุฉ ุฌุฒุฆูุฉ
    }

    applyCurrentFilters(results) {
        return results.filter(item => {
            return (!this.searchFilters.stage || item.stage === this.searchFilters.stage) &&
                   (!this.searchFilters.grade || item.grade === this.searchFilters.grade) &&
                   (!this.searchFilters.subject || item.subject === this.searchFilters.subject) &&
                   (!this.searchFilters.contentType || item.contentType === this.searchFilters.contentType) &&
                   (!this.searchFilters.difficulty || item.difficulty === this.searchFilters.difficulty);
        });
    }

    sortResults(results) {
        const sortBy = document.getElementById('sort-filter')?.value || 'relevance';
        
        switch (sortBy) {
            case 'downloads':
                return results.sort((a, b) => b.downloadCount - a.downloadCount);
            case 'rating':
                return results.sort((a, b) => parseFloat(b.rating) - parseFloat(a.rating));
            case 'newest':
                return results.sort((a, b) => new Date(b.publishDate) - new Date(a.publishDate));
            case 'title':
                return results.sort((a, b) => a.title.localeCompare(b.title, 'ar'));
            default:
                return results; // ุงูุฃูุซุฑ ุตูุฉ (ุงูุชุฑุชูุจ ุงูุงูุชุฑุงุถู)
        }
    }

    displayResults(results, query, searchTime) {
        const resultsContainer = document.getElementById('search-results');
        const resultsHeader = document.getElementById('results-header');
        const resultsCount = document.getElementById('results-count-text');
        const searchTimeSpan = document.getElementById('search-time');
        
        if (!resultsContainer) return;
        
        // ุฅุธูุงุฑ ูุนูููุงุช ุงููุชุงุฆุฌ
        if (resultsHeader && resultsCount && searchTimeSpan) {
            resultsHeader.style.display = 'flex';
            resultsCount.textContent = `${results.length} ูุชูุฌุฉ`;
            searchTimeSpan.textContent = `(${searchTime} ูููู ุซุงููุฉ)`;
        }
        
        // ุนุฑุถ ุงููุชุงุฆุฌ
        if (results.length === 0) {
            resultsContainer.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <h3>ูู ูุชู ุงูุนุซูุฑ ุนูู ูุชุงุฆุฌ</h3>
                    <p>ุฌุฑุจ ุชุนุฏูู ูููุงุช ุงูุจุญุซ ุฃู ุงูููุงุชุฑ</p>
                    <div class="search-suggestions-no-results">
                        <h4>ุงูุชุฑุงุญุงุช:</h4>
                        <ul>
                            <li>ุชุฃูุฏ ูู ูุชุงุจุฉ ุงููููุงุช ุจุดูู ุตุญูุญ</li>
                            <li>ุงุณุชุฎุฏู ูููุงุช ุฃูุซุฑ ุนููููุฉ</li>
                            <li>ููู ูู ุนุฏุฏ ุงูููุงุชุฑ ุงููุทุจูุฉ</li>
                            <li>ุฌุฑุจ ุงูุจุญุซ ูู ูุฑุญูุฉ ุชุนููููุฉ ุฃุฎุฑู</li>
                        </ul>
                    </div>
                </div>
            `;
        } else {
            const viewMode = document.querySelector('.view-toggle.active')?.dataset.view || 'grid';
            resultsContainer.className = `search-results ${viewMode}-view`;
            
            resultsContainer.innerHTML = results.map(item => this.createResultCard(item)).join('');
        }
        
        // ุฅุฎูุงุก ุงููุญุชูู ุงูุงูุชุฑุงุถู
        document.getElementById('search-history').style.display = 'none';
        document.querySelector('.popular-searches-section').style.display = 'none';
    }

    createResultCard(item) {
        return `
            <div class="result-card" data-id="${item.id}">
                <div class="result-thumbnail">
                    <img src="${item.thumbnail}" alt="${item.title}" loading="lazy"
                         onerror="this.src='images/placeholder.jpg'">
                    <div class="result-badges">
                        <span class="badge badge-${item.contentType}">${this.getContentTypeLabel(item.contentType)}</span>
                        <span class="badge badge-${item.difficulty}">${this.getDifficultyLabel(item.difficulty)}</span>
                    </div>
                </div>
                
                <div class="result-content">
                    <h3 class="result-title">${this.highlightSearchTerms(item.title)}</h3>
                    <p class="result-description">${this.highlightSearchTerms(item.description)}</p>
                    
                    <div class="result-meta">
                        <div class="meta-row">
                            <span><i class="fas fa-user"></i> ${item.author}</span>
                            <span><i class="fas fa-calendar"></i> ${item.publishDate}</span>
                        </div>
                        <div class="meta-row">
                            <span><i class="fas fa-download"></i> ${item.downloadCount.toLocaleString()}</span>
                            <span><i class="fas fa-star"></i> ${item.rating}</span>
                            <span><i class="fas fa-file"></i> ${item.fileSize}</span>
                        </div>
                    </div>
                    
                    <div class="result-actions">
                        <button class="btn-primary" onclick="enhancedSearchSystem.downloadFile('${item.downloadUrl}', '${item.title}')">
                            <i class="fas fa-download"></i> ุชุญููู
                        </button>
                        <button class="btn-secondary" onclick="enhancedSearchSystem.previewFile('${item.previewUrl}')">
                            <i class="fas fa-eye"></i> ูุนุงููุฉ
                        </button>
                        <button class="btn-icon bookmark-btn" onclick="enhancedSearchSystem.toggleBookmark('${item.id}')" 
                                title="ุฅุถุงูุฉ ููููุถูุฉ">
                            <i class="fas fa-bookmark"></i>
                        </button>
                        <button class="btn-icon share-btn" onclick="enhancedSearchSystem.shareItem('${item.id}')" 
                                title="ูุดุงุฑูุฉ">
                            <i class="fas fa-share"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    getContentTypeLabel(type) {
        const labels = {
            'book': 'ูุชุงุจ',
            'note': 'ูุฐูุฑุฉ',
            'exam': 'ุงูุชุญุงู',
            'review': 'ูุฑุงุฌุนุฉ'
        };
        return labels[type] || type;
    }

    getDifficultyLabel(difficulty) {
        const labels = {
            'beginner': 'ูุจุชุฏุฆ',
            'intermediate': 'ูุชูุณุท',
            'advanced': 'ูุชูุฏู'
        };
        return labels[difficulty] || difficulty;
    }

    highlightSearchTerms(text) {
        const query = document.getElementById('enhanced-search-input')?.value || '';
        if (!query.trim()) return text;
        
        const terms = query.trim().split(/\s+/);
        let highlightedText = text;
        
        terms.forEach(term => {
            const regex = new RegExp(`(${term})`, 'gi');
            highlightedText = highlightedText.replace(regex, '<mark>$1</mark>');
        });
        
        return highlightedText;
    }

    // ุจุงูู ุงูุฏูุงู...
    openSearch() {
        const modal = document.getElementById('enhanced-search-modal');
        if (modal) {
            modal.classList.add('active');
            document.body.classList.add('search-open');
            
            // ุงูุชุฑููุฒ ุนูู ุงูุจุญุซ
            setTimeout(() => {
                const input = document.getElementById('enhanced-search-input');
                if (input) input.focus();
            }, 100);
            
            this.showDefaultContent();
        }
    }

    closeSearch() {
        const modal = document.getElementById('enhanced-search-modal');
        if (modal) {
            modal.classList.remove('active');
            document.body.classList.remove('search-open');
        }
    }

    showDefaultContent() {
        document.getElementById('search-history').style.display = 'block';
        document.querySelector('.popular-searches-section').style.display = 'block';
        document.getElementById('results-header').style.display = 'none';
        
        this.displaySearchHistory();
        this.displayPopularSearches();
    }

    updateSearchFilters() {
        this.searchFilters = {
            stage: document.getElementById('stage-filter')?.value || '',
            grade: document.getElementById('grade-filter')?.value || '',
            subject: document.getElementById('subject-filter')?.value || '',
            contentType: document.getElementById('content-filter')?.value || '',
            difficulty: document.getElementById('difficulty-filter')?.value || '',
            language: 'ar'
        };
    }

    getSearchHistory() {
        return JSON.parse(localStorage.getItem('searchHistory') || '[]');
    }

    getSearchAnalytics() {
        return JSON.parse(localStorage.getItem('searchAnalytics') || '{}');
    }

    recordSearch(query) {
        if (!this.searchAnalytics.searches) {
            this.searchAnalytics.searches = {};
        }
        
        this.searchAnalytics.searches[query] = (this.searchAnalytics.searches[query] || 0) + 1;
        localStorage.setItem('searchAnalytics', JSON.stringify(this.searchAnalytics));
    }

    addToSearchHistory(query) {
        this.searchHistory = this.searchHistory.filter(item => item !== query);
        this.searchHistory.unshift(query);
        this.searchHistory = this.searchHistory.slice(0, 10); // ุงูุงุญุชูุงุธ ุจุขุฎุฑ 10 ุจุญุซุงุช
        
        localStorage.setItem('searchHistory', JSON.stringify(this.searchHistory));
    }

    displaySearchHistory() {
        const container = document.getElementById('history-items');
        if (!container) return;
        
        if (this.searchHistory.length === 0) {
            container.innerHTML = '<p class="no-history">ูุง ุชูุฌุฏ ุจุญุซุงุช ุณุงุจูุฉ</p>';
            return;
        }
        
        container.innerHTML = this.searchHistory
            .slice(0, 5)
            .map(query => `
                <div class="history-item" onclick="enhancedSearchSystem.searchFromHistory('${query}')">
                    <i class="fas fa-history"></i>
                    <span>${query}</span>
                    <button onclick="event.stopPropagation(); enhancedSearchSystem.removeFromHistory('${query}')" 
                            class="remove-history">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
    }

    displayPopularSearches() {
        const container = document.getElementById('popular-items');
        if (!container) return;
        
        const popular = [
            'ุฑูุงุถูุงุช ุฃููู ุงุจุชุฏุงุฆู',
            'ุงููุบุฉ ุงูุนุฑุจูุฉ ุซุงููุฉ ุงุจุชุฏุงุฆู',
            'ุงูุนููู ุฃููู ุฅุนุฏุงุฏู',
            'ุงูููุฒูุงุก ุฃููู ุซุงููู',
            'ูุฑุงุฌุนุฉ ููุงุฆูุฉ',
            'ุงูุชุญุงูุงุช ุณุงุจูุฉ'
        ];
        
        container.innerHTML = popular
            .map(query => `
                <div class="popular-item" onclick="enhancedSearchSystem.searchFromHistory('${query}')">
                    <i class="fas fa-fire"></i>
                    <span>${query}</span>
                </div>
            `).join('');
    }

    searchFromHistory(query) {
        const input = document.getElementById('enhanced-search-input');
        if (input) {
            input.value = query;
            this.performSearch(query);
        }
    }

    // ุชูุนูู ุงููุธุงู
    enableSmartSearch() {
        console.log('โ ุชู ุชูุนูู ุงูุจุญุซ ุงูุฐูู');
    }

    initSearchAnalytics() {
        console.log('๐ ุชู ุชูุนูู ุชุญูููุงุช ุงูุจุญุซ');
    }
}

// ุชุดุบูู ุงููุธุงู
document.addEventListener('DOMContentLoaded', () => {
    window.enhancedSearchSystem = new EnhancedSearchSystem();
});

// ุชุตุฏูุฑ ููุงุณุชุฎุฏุงู ุงูุฎุงุฑุฌู
window.EnhancedSearchSystem = EnhancedSearchSystem;
